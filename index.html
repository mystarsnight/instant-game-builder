<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Instant Game Builder (Supabase)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#b3d9ff;margin:0;padding:10px}
#app{background:#fff;border-radius:12px;padding:12px;max-width:900px;margin:auto}
textarea,button,input{width:100%;padding:10px;margin:6px 0;border-radius:8px;font-size:14px}
button{background:#4caf50;color:#fff;border:none;cursor:pointer}
#gameArea{margin-top:15px;height:350px;border-radius:10px;background:#e3f2fd;position:relative;overflow:hidden}
.obj{position:absolute;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#fff;cursor:pointer;user-select:none}
#stats{margin-top:10px;font-weight:bold}
.listItem{padding:6px;background:#eee;margin:4px 0;border-radius:6px;cursor:pointer}
.notice{background:#222;color:#fff;padding:10px;border-radius:8px;margin:6px 0;display:none}
.admin{background:#ffebee;border:2px solid #e53935;padding:8px;border-radius:8px;margin-top:10px}
.small{font-size:12px;color:#555}
</style>
</head>
<body>
<div id="app">
<h2>Instant Game Builder</h2>


<div id="notice" class="notice"></div>

<h3>Account</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login / Sign Up</button>
<div id="userStatus" class="small"></div>

<h3>Game Rules</h3>
<textarea id="input" rows="6"></textarea>

<button onclick="buildGame()">Build & Play</button>
<button onclick="saveGame()">Save</button>
<button onclick="publishGame()">Publish</button>
<button onclick="shareGame()">Share</button>
<button onclick="joinMultiplayer()">Join Multiplayer</button>

<div id="gameArea"></div>
<div id="stats"></div>

<h3>My Games</h3>
<div id="myGames"></div>

<h3>Public Games</h3>
<div id="publicGames"></div>

<div id="adminPanel" class="admin" style="display:none">
<h3>Admin Panel</h3>
<div id="adminGames"></div>
</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://tmnpqtedyvifvabhvswl.supabase.co',
  'sb_publishable_EnfDPdGC3knvrMKgIrtU2g_2zUJL_Fs'
)

let user=null, isAdmin=false
const SUPER_ADMIN_EMAIL = 'blakestalder123@gmail.com'

function show(msg){ notice.innerText=msg; notice.style.display='block'; setTimeout(()=>notice.style.display='none',3000) }

// ===== AUTH =====
window.login=async()=>{
  const e=email.value,p=password.value
  let r=await supabase.auth.signInWithPassword({email:e,password:p})
  if(r.error) r=await supabase.auth.signUp({email:e,password:p})
  if(r.error) return show(r.error.message)
  user=r.data.user
  userStatus.innerText='Logged in as '+user.email
  isAdmin = user.email === SUPER_ADMIN_EMAIL('@admin.com')
  adminPanel.style.display=isAdmin?'block':'none'
  show('Logged in')
  loadMyGames(); loadPublic(); if(isAdmin) loadAdmin()
}

// ===== GAME ENGINE =====
let rules=[],objects={},score=0,winScore=999,keys={}
window.buildGame=()=>{
  gameArea.innerHTML=''; objects={}; score=0
  rules=input.value.split('\n').filter(Boolean)
  rules.forEach(r=>{ if(r.startsWith('spawn')) spawn(r.split(' ')[1]); if(r.startsWith('score to win')) winScore=parseInt(r.split(' ').pop()) })
  update()
}

function spawn(n){
  const d=document.createElement('div'); d.className='obj'; d.innerText=n.toUpperCase()
  d.style.width='60px'; d.style.height='60px'; d.style.background=n==='coin'?'#fbc02d':'#43a047'
  d.style.left=Math.random()*80+'%'; d.style.top=Math.random()*80+'%'
  d.onclick=()=>{ rules.forEach(r=>{ if(r.startsWith('click '+n)&&r.includes('gain')) score+=parseInt(r.split('gain')[1]) }); update() }
  gameArea.appendChild(d); objects[n]=d
}

window.onkeydown=e=>keys[e.key]=true
window.onkeyup=e=>keys[e.key]=false
setInterval(()=>{
  if(objects.player && rules.includes('press arrow move player')){
    const p=objects.player; let x=p.offsetLeft,y=p.offsetTop
    if(keys.ArrowLeft)x-=5;if(keys.ArrowRight)x+=5;if(keys.ArrowUp)y-=5;if(keys.ArrowDown)y+=5
    p.style.left=x+'px'; p.style.top=y+'px'
    syncPlayer()
  }
},40)

function update(){ if(score>=winScore){ stats.innerText='YOU WIN'; show('You win') } else stats.innerText='Score: '+score }

// ===== LOCAL SAVE / LOAD (NO ACCOUNT NEEDED) =====
window.saveGame=()=>{
  const games=JSON.parse(localStorage.getItem('myGames')||'[]')
  games.push({rules:input.value,created:Date.now()})
  localStorage.setItem('myGames',JSON.stringify(games))
  show('Saved locally')
  loadMyGames()
}

function loadMyGames(){
  const games=JSON.parse(localStorage.getItem('myGames')||'[]')
  myGames.innerHTML=''
  games.forEach((g,i)=>{
    const d=document.createElement('div')
    d.className='listItem'
    d.innerText='Local Game '+(i+1)
    d.onclick=()=>{ input.value=g.rules; buildGame() }
    myGames.appendChild(d)
  })
}

function loadPublic(){}

async function loadMyGames(){ if(!user) return; const {data}=await supabase.from('games').select('*').eq('user_id',user.id); myGames.innerHTML=''; data.forEach(g=>{ const d=document.createElement('div'); d.className='listItem'; d.innerText='My Game'; d.onclick=()=>{input.value=g.rules; buildGame()}; myGames.appendChild(d) }) }
async function loadPublic(){ const {data}=await supabase.from('games').select('*').eq('public',true).eq('flagged',false); publicGames.innerHTML=''; data.forEach(g=>{ const d=document.createElement('div'); d.className='listItem'; d.innerText='Public Game'; d.onclick=()=>{input.value=g.rules; buildGame()}; publicGames.appendChild(d) }) }

// ===== ADMIN =====
async function loadAdmin(){ if(!isAdmin) return;(){ const {data}=await supabase.from('games').select('*'); adminGames.innerHTML=''; data.forEach(g=>{ const d=document.createElement('div'); d.className='listItem'; d.innerText=(g.public?'[PUBLIC] ':'')+g.rules.split('\n')[0]; const b=document.createElement('button'); b.innerText='FLAG'; b.onclick=async()=>{ await supabase.from('games').update({flagged:true}).eq('id',g.id); show('Flagged'); loadAdmin() }; d.appendChild(b); adminGames.appendChild(d) }) }

// ===== MULTIPLAYER (REALTIME) =====
let room=null
window.joinMultiplayer=async()=>{
  room=prompt('Room name?')
  if(!room) return
  await supabase.from('players').upsert({room:room,user_id:user.id,x:0,y:0})
  show('Joined room '+room)
}

async function syncPlayer(){ if(!room||!user||!objects.player) return; await supabase.from('players').upsert({room:room,user_id:user.id,x:objects.player.offsetLeft,y:objects.player.offsetTop}) }

supabase.channel('players').on('postgres_changes',{event:'*',schema:'public',table:'players'},payload=>{
  if(!room||payload.new.room!==room||payload.new.user_id===user?.id) return
  let o=objects['p_'+payload.new.user_id]
  if(!o){ o=document.createElement('div'); o.className='obj'; o.style.background='#1e88e5'; o.innerText='P'; gameArea.appendChild(o); objects['p_'+payload.new.user_id]=o }
  o.style.left=payload.new.x+'px'; o.style.top=payload.new.y+'px'
}).subscribe()

// ===== SHARE =====
window.shareGame=()=>{ const u=btoa(encodeURIComponent(input.value)); navigator.clipboard.writeText(location.origin+location.pathname+'?game='+u); show('Link copied') }

(function(){ const p=new URLSearchParams(location.search); if(p.has('game')){ input.value=decodeURIComponent(atob(p.get('game'))); buildGame() } })()
</script>
</body>
</html>
