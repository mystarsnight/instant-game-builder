<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Instant Game Builder</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#b3d9ff}
#app{max-width:900px;margin:auto;background:#fff;padding:12px;border-radius:12px}
textarea,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;font-size:14px}
button{background:#4caf50;color:#fff;border:none}
button.small{width:auto;padding:6px 10px;font-size:12px}
#game{height:320px;background:#e3f2fd;border-radius:10px;position:relative;overflow:hidden}
.obj{width:60px;height:60px;border-radius:12px;position:absolute;
display:flex;align-items:center;justify-content:center;
color:#fff;font-weight:bold;user-select:none}
.row{display:flex;gap:6px;background:#eee;padding:6px;border-radius:6px;margin:4px 0}
#notice{background:#222;color:#fff;padding:8px;border-radius:6px;display:none}

/* MODAL */
#overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:999;
}
#modal{background:#fff;padding:20px;border-radius:12px;max-width:320px;text-align:center}
#modal button{margin-top:10px}

/* MOBILE AI BOX */
#mobileAI{
  display:none;background:#e8f5e9;padding:12px;border-radius:10px;margin-bottom:10px
}
</style>
</head>
<body>

<!-- FIRST VISIT POPUP -->
<div id="overlay">
  <div id="modal">
    <h3>Welcome ðŸ‘‹</h3>
    <p>You need to use <b>AI</b> to make a game right now.<br>
    Tap <b>AI Make Game</b> to start.</p>
    <button onclick="dismiss()">OK</button>
  </div>
</div>

<div id="app">
<h2>Instant Game Builder</h2>

<div id="mobileAI">
  <b>ðŸ“± Mobile Tip</b><br>
  Tap <b>AI Make Game</b> to instantly create a game.
</div>

<div id="notice"></div>

<textarea id="rules" rows="6"></textarea>

<button onclick="buildGame()">Build & Play</button>
<button onclick="aiGame()">ðŸ¤– AI Make Game</button>
<button onclick="saveGame()">ðŸ’¾ Save</button>
<button onclick="copyLink()">ðŸ”— Copy Link</button>

<div id="game"></div>
<div id="stats"></div>

<h3>My Games</h3>
<div id="library"></div>
</div>

<script>
/* ---------- FIRST VISIT ---------- */
function dismiss(){
  overlay.style.display="none"
  localStorage.setItem("aiNoticeSeen","1")
}
if(!localStorage.getItem("aiNoticeSeen")){
  overlay.style.display="flex"
}
if(/Mobi|Android/i.test(navigator.userAgent)){
  mobileAI.style.display="block"
}

/* ---------- BASIC ---------- */
const rulesBox=rules
const game=document.getElementById("game")
const stats=document.getElementById("stats")
const lib=document.getElementById("library")
const notice=document.getElementById("notice")
function msg(t){notice.innerText=t;notice.style.display="block";setTimeout(()=>notice.style.display="none",2000)}

let rulesArr=[],objs={},score=0,win=5,keys={}

/* ---------- BUILD ---------- */
function buildGame(){
  game.innerHTML=""
  objs={}
  score=0
  win=5
  rulesArr=rulesBox.value.split("\n").map(r=>r.trim()).filter(Boolean)

  rulesArr.forEach(r=>{
    if(r.startsWith("spawn ")) spawn(r.split(" ")[1])
    if(r.startsWith("score to win")) win=parseInt(r.split(" ").pop())||5
  })
  update()
}

/* ---------- OBJECTS ---------- */
function spawn(name){
  const d=document.createElement("div")
  d.className="obj"
  d.style.left=Math.random()*80+"%"
  d.style.top=Math.random()*80+"%"
  d.style.background=color(name)
  d.innerText=name[0].toUpperCase()

  d.onclick=()=>{
    rulesArr.forEach(r=>{
      if(r.startsWith("click "+name) && r.includes("gain")){
        score+=parseInt(r.split("gain")[1])||1
      }
    })
    update()
  }

  game.appendChild(d)
  objs[name]=d
}

function color(n){
  const c=["#e53935","#1e88e5","#43a047","#fb8c00","#8e24aa"]
  let h=0;for(let x of n)h+=x.charCodeAt(0)
  return c[h%c.length]
}

/* ---------- MOVEMENT ---------- */
window.onkeydown=e=>keys[e.key]=true
window.onkeyup=e=>keys[e.key]=false
setInterval(()=>{
  if(objs.player && rulesArr.includes("move arrows")){
    let p=objs.player
    let x=p.offsetLeft,y=p.offsetTop
    if(keys.ArrowLeft)x-=5
    if(keys.ArrowRight)x+=5
    if(keys.ArrowUp)y-=5
    if(keys.ArrowDown)y+=5
    p.style.left=x+"px";p.style.top=y+"px"
  }
},40)

/* ---------- UPDATE ---------- */
function update(){
  if(score>=win){
    stats.innerText="YOU WIN ðŸŽ‰"
    msg("You win!")
  }else{
    stats.innerText=`Score: ${score} / ${win}`
  }
}

/* ---------- REAL AI (VARIATION) ---------- */
function aiGame(){
  const winTarget=Math.floor(Math.random()*10)+3
  const gain=Math.floor(Math.random()*3)+1
  const withMove=Math.random()>0.4
  const extra=Math.random()>0.6

  let out=["spawn player"]
  if(withMove) out.push("move arrows")
  out.push("spawn coin")
  out.push(`click coin gain ${gain}`)

  if(extra){
    out.push("spawn gem")
    out.push(`click gem gain ${gain+1}`)
  }

  out.push(`score to win ${winTarget}`)
  rulesBox.value=out.join("\n")
  buildGame()
  msg("AI generated a new game")
}

/* ---------- SAVE ---------- */
function getGames(){return JSON.parse(localStorage.getItem("games")||"[]")}
function setGames(g){localStorage.setItem("games",JSON.stringify(g))}

function saveGame(){
  const name=prompt("Game name","My Game")
  if(!name) return
  const g=getGames()
  g.push({id:Date.now(),name,rules:rulesBox.value})
  setGames(g);loadGames();msg("Saved")
}

function loadGames(){
  lib.innerHTML=""
  getGames().forEach(g=>{
    const r=document.createElement("div")
    r.className="row"
    r.innerHTML="<b>"+g.name+"</b>"
    r.append(
      btn("Play",()=>{rulesBox.value=g.rules;buildGame()}),
      btn("Rename",()=>{
        const n=prompt("New name",g.name)
        if(n){g.name=n;setGames(getGames());loadGames()}
      }),
      btn("Delete",()=>{
        if(confirm("Delete?")){
          setGames(getGames().filter(x=>x.id!==g.id));loadGames()
        }
      })
    )
    lib.appendChild(r)
  })
}
function btn(t,f){const b=document.createElement("button");b.className="small";b.innerText=t;b.onclick=f;return b}
loadGames()

/* ---------- SHARE ---------- */
function copyLink(){
  const d=btoa(encodeURIComponent(rulesBox.value))
  navigator.clipboard.writeText(location.origin+location.pathname+"?g="+d)
  msg("Link copied")
}
const q=new URLSearchParams(location.search)
if(q.has("g")){
  rulesBox.value=decodeURIComponent(atob(q.get("g")))
  buildGame()
}
</script>
</body>
</html>
