<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Instant Game Builder</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#b3d9ff;margin:0;padding:10px}
#app{background:#fff;border-radius:12px;padding:12px;max-width:900px;margin:auto}
textarea,button,input{width:100%;padding:10px;margin:6px 0;border-radius:8px;font-size:14px}
button{background:#4caf50;color:#fff;border:none;cursor:pointer}
.small{width:auto;padding:6px 10px;font-size:12px;margin-left:4px}
#gameArea{margin-top:15px;height:350px;border-radius:10px;background:#e3f2fd;position:relative;overflow:hidden}
.obj{position:absolute;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#fff;cursor:pointer;user-select:none}
#stats{margin-top:10px;font-weight:bold}
.row{background:#eee;padding:6px;border-radius:6px;margin:4px 0;display:flex;align-items:center;gap:6px}
.notice{background:#222;color:#fff;padding:10px;border-radius:8px;margin:6px 0;display:none}
</style>
</head>
<body>

<div id="app">
<h2>Instant Game Builder</h2>

<div id="notice" class="notice"></div>

<textarea id="input" rows="6" placeholder="Example:
spawn player
spawn coin
click coin gain 1
score to win 5
press arrow move player"></textarea>

<button onclick="build()">Build & Play</button>
<button onclick="save()">Save</button>

<div id="gameArea"></div>
<div id="stats"></div>

<h3>My Games</h3>
<div id="games"></div>
</div>

<script>
/* ===== HELPERS ===== */
const input=document.getElementById('input')
const gameArea=document.getElementById('gameArea')
const stats=document.getElementById('stats')
const gamesDiv=document.getElementById('games')
const notice=document.getElementById('notice')

function show(msg){
  notice.innerText=msg
  notice.style.display='block'
  setTimeout(()=>notice.style.display='none',2500)
}

/* ===== GAME STATE ===== */
let rules=[],objects={},score=0,winScore=5,keys={}

/* ===== GAME ENGINE ===== */
function build(){
  gameArea.innerHTML=''
  objects={}
  score=0
  winScore=5

  rules=input.value.split('\n').map(r=>r.trim()).filter(Boolean)

  rules.forEach(r=>{
    if(r.startsWith('spawn ')) spawn(r.split(' ')[1])
    if(r.startsWith('score to win')) winScore=parseInt(r.split(' ').pop())||5
  })

  update()
}

function spawn(name){
  const d=document.createElement('div')
  d.className='obj'
  d.style.width='64px'
  d.style.height='64px'
  d.style.borderRadius='12px'
  d.style.backgroundImage=`url(${aiImage(name)})`
  d.style.backgroundSize='cover'
  d.style.left=Math.random()*280+'px'
  d.style.top=Math.random()*220+'px'

  d.onclick=()=>{
    rules.forEach(r=>{
      if(r.startsWith('click '+name) && r.includes('gain')){
        score+=parseInt(r.split('gain')[1])||1
      }
    })
    update()
  }

  gameArea.appendChild(d)
  objects[name]=d
}

function aiImage(name){
  const colors=['#ef5350','#42a5f5','#66bb6a','#ffa726','#ab47bc']
  let h=0;for(let c of name)h+=c.charCodeAt(0)
  const c=colors[h%colors.length]
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>
  <rect rx='12' width='100%' height='100%' fill='${c}'/>
  <text x='50%' y='55%' font-size='32' fill='white' text-anchor='middle'>${name[0].toUpperCase()}</text>
  </svg>`
  return 'data:image/svg+xml;base64,'+btoa(svg)
}

/* ===== MOVEMENT ===== */
window.onkeydown=e=>keys[e.key]=true
window.onkeyup=e=>keys[e.key]=false

setInterval(()=>{
  if(objects.player && rules.includes('press arrow move player')){
    let p=objects.player
    let x=p.offsetLeft,y=p.offsetTop
    if(keys.ArrowLeft)x-=5
    if(keys.ArrowRight)x+=5
    if(keys.ArrowUp)y-=5
    if(keys.ArrowDown)y+=5
    p.style.left=x+'px'
    p.style.top=y+'px'
  }
},40)

function update(){
  stats.innerText=score>=winScore?'YOU WIN ðŸŽ‰':'Score: '+score+' / '+winScore
}

/* ===== LOCAL SAVES ===== */
function getGames(){return JSON.parse(localStorage.getItem('games')||'[]')}
function setGames(g){localStorage.setItem('games',JSON.stringify(g))}

function save(){
  const name=prompt('Game name?','My Game')
  if(!name) return
  const g=getGames()
  g.push({id:Date.now(),name,rules:input.value})
  setGames(g)
  load()
  show('Saved')
}

function load(){
  gamesDiv.innerHTML=''
  getGames().forEach(game=>{
    const r=document.createElement('div')
    r.className='row'

    const t=document.createElement('span')
    t.innerText=game.name

    const play=b('Play',()=>{input.value=game.rules;build()})
    const rename=b('Rename',()=>{
      const n=prompt('New name',game.name)
      if(n){const g=getGames();g.find(x=>x.id===game.id).name=n;setGames(g);load()}
    })
    const del=b('Delete',()=>{
      if(confirm('Delete?')){setGames(getGames().filter(x=>x.id!==game.id));load()}
    })
    const link=b('Copy Link',()=>copyLink(game.rules))

    r.append(t,play,rename,del,link)
    gamesDiv.appendChild(r)
  })
}
load()

function b(txt,fn){
  const x=document.createElement('button')
  x.className='small'
  x.innerText=txt
  x.onclick=fn
  return x
}

/* ===== SHARE ===== */
function copyLink(data){
  const code=btoa(encodeURIComponent(data))
  const url=location.origin+location.pathname+'?game='+code
  navigator.clipboard.writeText(url)
  show('Link copied')
}

const q=new URLSearchParams(location.search)
if(q.has('game')){
  input.value=decodeURIComponent(atob(q.get('game')))
  build()
}
</script>

</body>
</html>
